#!/usr/bin/env bash
# Pre-commit hook for sbx-lite
# Enforces code quality checks before allowing commits
#
# Installation:
#   bash hooks/install-hooks.sh
#
# To bypass (ONLY in emergencies):
#   git commit --no-verify

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get repo root
REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT" || exit 1

echo -e "${BLUE}=== Running Pre-Commit Checks ===${NC}"
echo ""

# Track overall pass/fail
CHECKS_PASSED=0
CHECKS_FAILED=0

#==============================================================================
# Check 1: Bash Syntax Validation
#==============================================================================
echo -e "${BLUE}[1/5]${NC} Checking bash syntax..."

syntax_errors=0
# Check main installer
if ! bash -n install.sh 2>/dev/null; then
    echo -e "${RED}✗ FAIL${NC}: install.sh has syntax errors"
    bash -n install.sh
    syntax_errors=$((syntax_errors + 1))
fi

# Check all library modules
for module in lib/*.sh; do
    if ! bash -n "$module" 2>/dev/null; then
        echo -e "${RED}✗ FAIL${NC}: $module has syntax errors"
        bash -n "$module"
        syntax_errors=$((syntax_errors + 1))
    fi
done

# Check manager
if [[ -f bin/sbx-manager.sh ]] && ! bash -n bin/sbx-manager.sh 2>/dev/null; then
    echo -e "${RED}✗ FAIL${NC}: bin/sbx-manager.sh has syntax errors"
    bash -n bin/sbx-manager.sh
    syntax_errors=$((syntax_errors + 1))
fi

if [[ $syntax_errors -eq 0 ]]; then
    echo -e "${GREEN}✓ PASS${NC}: All bash scripts have valid syntax"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}: Found $syntax_errors files with syntax errors"
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
fi
echo ""

#==============================================================================
# Check 2: Bootstrap Constants Validation
#==============================================================================
echo -e "${BLUE}[2/5]${NC} Validating bootstrap constants..."

if bash tests/unit/test_bootstrap_constants.sh > /tmp/pre-commit-bootstrap.log 2>&1; then
    echo -e "${GREEN}✓ PASS${NC}: Bootstrap constants properly configured"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}: Bootstrap constants validation failed"
    echo ""
    echo "Error details:"
    cat /tmp/pre-commit-bootstrap.log | grep -A3 "✗ FAIL" || cat /tmp/pre-commit-bootstrap.log
    echo ""
    echo -e "${YELLOW}Remediation:${NC}"
    echo "  1. Check which constants are missing: cat /tmp/pre-commit-bootstrap.log"
    echo "  2. Add missing constants to install.sh early section (lines 16-44)"
    echo "  3. Update lib/common.sh with conditional declarations"
    echo "  4. See tests/unit/README_BOOTSTRAP_TESTS.md for detailed guide"
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
fi
rm -f /tmp/pre-commit-bootstrap.log
echo ""

#==============================================================================
# Check 3: Strict Mode Enforcement
#==============================================================================
echo -e "${BLUE}[3/5]${NC} Checking strict mode (set -euo pipefail)..."

missing_strict_mode=()

# Check install.sh
if ! grep -q "^set -euo pipefail" install.sh; then
    missing_strict_mode+=("install.sh")
fi

# Check all library modules
for module in lib/*.sh; do
    if ! grep -q "^set -euo pipefail" "$module"; then
        missing_strict_mode+=("$module")
    fi
done

# Check manager
if [[ -f bin/sbx-manager.sh ]] && ! grep -q "^set -euo pipefail" bin/sbx-manager.sh; then
    missing_strict_mode+=("bin/sbx-manager.sh")
fi

if [[ ${#missing_strict_mode[@]} -eq 0 ]]; then
    echo -e "${GREEN}✓ PASS${NC}: All scripts use strict mode"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
else
    echo -e "${RED}✗ FAIL${NC}: Scripts missing 'set -euo pipefail':"
    for script in "${missing_strict_mode[@]}"; do
        echo "  - $script"
    done
    echo ""
    echo -e "${YELLOW}Remediation:${NC}"
    echo "  Add 'set -euo pipefail' at the top of each script (after shebang)"
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
fi
echo ""

#==============================================================================
# Check 4: ShellCheck Linting (if available)
#==============================================================================
echo -e "${BLUE}[4/5]${NC} Running ShellCheck linting..."

if command -v shellcheck >/dev/null 2>&1; then
    shellcheck_errors=0

    # Check main files with moderate severity
    for file in install.sh lib/*.sh bin/sbx-manager.sh; do
        [[ ! -f "$file" ]] && continue

        # Exclude some style warnings
        if ! shellcheck -S warning -e SC2250 "$file" >/dev/null 2>&1; then
            shellcheck_errors=$((shellcheck_errors + 1))
            echo -e "${YELLOW}  Warnings in:${NC} $file"
            shellcheck -S warning -e SC2250 "$file" | head -20
        fi
    done

    if [[ $shellcheck_errors -eq 0 ]]; then
        echo -e "${GREEN}✓ PASS${NC}: ShellCheck found no issues"
        CHECKS_PASSED=$((CHECKS_PASSED + 1))
    else
        echo -e "${YELLOW}⚠ WARNING${NC}: ShellCheck found $shellcheck_errors files with warnings"
        echo "  (Not blocking commit, but please review)"
        CHECKS_PASSED=$((CHECKS_PASSED + 1))
    fi
else
    echo -e "${YELLOW}⚠ SKIP${NC}: ShellCheck not installed"
    echo "  Install with: apt install shellcheck (or brew install shellcheck)"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi
echo ""

#==============================================================================
# Check 5: Unbound Variable Detection
#==============================================================================
echo -e "${BLUE}[5/5]${NC} Testing for unbound variables (bash -u)..."

# Test that help text works without unbound variables
unbound_test=$(timeout 5 bash -u install.sh --help 2>&1 || true)

if echo "$unbound_test" | grep -q "unbound variable"; then
    echo -e "${RED}✗ FAIL${NC}: Found unbound variable usage"
    echo ""
    echo "Error details:"
    echo "$unbound_test" | grep -A2 "unbound variable" | head -10
    echo ""
    echo -e "${YELLOW}Remediation:${NC}"
    echo "  1. Identify the unbound variable from error above"
    echo "  2. Initialize all local variables: local var=\"\""
    echo "  3. Use safe expansion for optional vars: \${VAR:-default}"
    echo "  4. See CLAUDE.md 'Variable Initialization Pattern' section"
    CHECKS_FAILED=$((CHECKS_FAILED + 1))
else
    echo -e "${GREEN}✓ PASS${NC}: No unbound variables detected"
    CHECKS_PASSED=$((CHECKS_PASSED + 1))
fi
echo ""

#==============================================================================
# Summary and Exit
#==============================================================================
echo "========================================"
echo -e "${BLUE}Pre-Commit Check Summary${NC}"
echo "----------------------------------------"
echo -e "Passed: ${GREEN}${CHECKS_PASSED}/5${NC}"
echo -e "Failed: ${RED}${CHECKS_FAILED}/5${NC}"
echo "========================================"
echo ""

if [[ $CHECKS_FAILED -gt 0 ]]; then
    echo -e "${RED}✗ Pre-commit checks FAILED${NC}"
    echo ""
    echo "Your commit has been blocked because it would introduce issues."
    echo ""
    echo -e "${YELLOW}What to do:${NC}"
    echo "  1. Fix the issues listed above"
    echo "  2. Stage your changes: git add <files>"
    echo "  3. Try committing again: git commit"
    echo ""
    echo -e "${YELLOW}Emergency bypass (NOT recommended):${NC}"
    echo "  git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}✓ All pre-commit checks passed!${NC}"
    echo ""
    echo "Proceeding with commit..."
    exit 0
fi
