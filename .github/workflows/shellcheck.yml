name: ShellCheck & Code Quality

on:
  push:
    branches: [ main, develop, feature/*, claude/** ]
    paths:
      - '**.sh'
      - 'lib/**'
      - 'bin/**'
      - '.github/workflows/shellcheck.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.sh'
      - 'lib/**'
      - 'bin/**'

# Cancel in-progress runs when a new workflow is triggered on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  shellcheck:
    name: ShellCheck Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Cache ShellCheck
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: ~/.cache/shellcheck
          key: ${{ runner.os }}-shellcheck-v1-${{ hashFiles('lib/**/*.sh', 'bin/**/*.sh', '.github/workflows/shellcheck.yml') }}
          restore-keys: |
            ${{ runner.os }}-shellcheck-v1-
            ${{ runner.os }}-shellcheck-

      - name: Install ShellCheck
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
          shellcheck --version

      - name: Run ShellCheck
        run: |
          echo "# ShellCheck Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          exit_code=0
          count=0
          failed_files=()

          for script in install.sh lib/*.sh bin/*.sh; do
            [[ -f "$script" ]] || continue
            count=$((count + 1))
            echo "[$count] Checking $script..."

            if output=$(shellcheck -e SC1090 -e SC1091 -S error "$script" 2>&1); then
              echo "✓ $script" >> $GITHUB_STEP_SUMMARY
            else
              echo "✗ $script - FAILED" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              echo "$output" >> $GITHUB_STEP_SUMMARY
              echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
              failed_files+=("$script")
              exit_code=1
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Summary**: Checked $count scripts" >> $GITHUB_STEP_SUMMARY

          if [[ $exit_code -eq 0 ]]; then
            echo "✅ All ShellCheck tests passed ($count scripts)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ ${#failed_files[@]} file(s) failed ShellCheck" >> $GITHUB_STEP_SUMMARY
            for file in "${failed_files[@]}"; do
              echo "::error file=$file::ShellCheck failed"
            done
          fi

          exit $exit_code

  syntax-check:
    name: Bash Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check syntax of all shell scripts
        run: |
          echo "# Bash Syntax Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Bash version: $(bash --version | head -1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          error_count=0
          for script in install.sh lib/*.sh bin/*.sh; do
            [[ -f "$script" ]] || continue
            if bash -n "$script" 2>&1; then
              echo "✓ $script" >> $GITHUB_STEP_SUMMARY
            else
              echo "✗ $script - FAILED" >> $GITHUB_STEP_SUMMARY
              echo "::error file=$script::Syntax error"
              ((error_count++))
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ Found $error_count syntax error(s)" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All scripts have valid syntax" >> $GITHUB_STEP_SUMMARY

  code-style:
    name: Code Style & Best Practices
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check for strict mode
        run: |
          echo "# Code Style Checks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Strict Mode Compliance" >> $GITHUB_STEP_SUMMARY

          MISSING_STRICT_MODE=0
          for script in lib/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -20 "$script" | grep -q 'set -'; then
              echo "❌ Missing strict mode: $script" >> $GITHUB_STEP_SUMMARY
              echo "::error file=$script::Missing strict mode (set -euo pipefail)"
              MISSING_STRICT_MODE=1
            else
              echo "✅ $script" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [[ $MISSING_STRICT_MODE -eq 1 ]]; then
            exit 1
          fi

      - name: Check script headers
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Shebang Compliance" >> $GITHUB_STEP_SUMMARY

          error_count=0
          for script in install.sh lib/*.sh bin/*.sh; do
            [[ -f "$script" ]] || continue
            if ! head -1 "$script" | grep -q '^#!/'; then
              echo "❌ Missing shebang: $script" >> $GITHUB_STEP_SUMMARY
              echo "::error file=$script::Missing shebang line"
              ((error_count++))
            else
              echo "✅ $script" >> $GITHUB_STEP_SUMMARY
            fi
          done

          if [[ $error_count -gt 0 ]]; then
            exit 1
          fi

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run security checks
        run: |
          echo "# Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for unsafe eval usage
          if grep -rn 'eval.*\$' --include="*.sh" lib/ bin/ 2>/dev/null; then
            echo "❌ Found unsafe eval usage" >> $GITHUB_STEP_SUMMARY
            echo "::error::Unsafe eval usage detected"
            exit 1
          fi
          echo "✅ No unsafe eval usage" >> $GITHUB_STEP_SUMMARY

          # Check for hardcoded secrets/passwords
          if grep -rniE '(password|secret|api_?key|token).*=.*["\047][^"\047]{8,}' --include="*.sh" lib/ bin/ 2>/dev/null | grep -v "PASSWORD_LENGTH"; then
            echo "⚠️ Potential hardcoded secrets found" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Potential hardcoded secrets detected - please review"
          else
            echo "✅ No hardcoded secrets detected" >> $GITHUB_STEP_SUMMARY
          fi

          # Check for unsafe temp file usage
          if grep -rn 'mktemp.*-p /tmp' --include="*.sh" lib/ bin/ 2>/dev/null; then
            echo "⚠️ Unsafe temp file usage detected" >> $GITHUB_STEP_SUMMARY
            echo "::warning::Consider using secure temp file helpers"
          else
            echo "✅ Safe temp file usage" >> $GITHUB_STEP_SUMMARY
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Cache dependencies
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.cache/apt
          key: ${{ runner.os }}-apt-v1-${{ hashFiles('.github/workflows/shellcheck.yml') }}
          restore-keys: |
            ${{ runner.os }}-apt-v1-
            ${{ runner.os }}-apt-

      - name: Install test dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y jq
          jq --version

      - name: Run unit tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Unit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          test_count=$(find tests/unit -name 'test_*.sh' -type f 2>/dev/null | wc -l)
          echo "**Test Count**: $test_count test files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if bash tests/test-runner.sh; then
            echo "✅ All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, syntax-check, code-style, security-scan, unit-tests]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Generate summary
        run: |
          echo "# Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ShellCheck | ${{ needs.shellcheck.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Syntax Check | ${{ needs.syntax-check.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Style | ${{ needs.code-style.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result == 'success' && '✅ Passed' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall**: ${{ needs.shellcheck.result == 'success' && needs.syntax-check.result == 'success' && needs.code-style.result == 'success' && needs.security-scan.result == 'success' && needs.unit-tests.result == 'success' && '✅ All checks passed' || '❌ Some checks failed' }}" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [[ "${{ needs.shellcheck.result }}" != "success" ]] || \
             [[ "${{ needs.syntax-check.result }}" != "success" ]] || \
             [[ "${{ needs.code-style.result }}" != "success" ]] || \
             [[ "${{ needs.security-scan.result }}" != "success" ]] || \
             [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "::error::One or more quality checks failed"
            exit 1
          fi
